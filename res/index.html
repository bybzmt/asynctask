<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <script src="/jquery-3.2.1.min.js"></script>
    <style>
body{
    padding:0;
    margin:0;
}

table {
    margin: 1em;
    border-collapse:collapse;
}
table td, table th{
    border:1px solid #777;
    padding: 0px 1em;
}
.center {
    text-align:center;
}
#tab {
    margin: 0 0.5em;
}
#tab span {
    margin: auto 0.5em;
    color: #777;
}
#tab span.active {
    color: black;
    font-weight: bold;
}
    </style>
</head>
<body>

<div id="All">
    <table>
        <thead>
            <tr>
                <th class="name">名称</th>
                <th class="load">负载</th>
                <th class="now">执行中</th>
                <th class="run">己执行</th>
                <th class="old">昨天</th>
                <th class="wait">队列</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

<div id="tab">
    <span class="run" onclick="setTab(1)">runing</span>
    <span class="wait" onclick="setTab(2)">waiting</span>
    <span class="idle" onclick="setTab(3)">idle</span>
    <span class="all" onclick="setTab(4)">all</span>
</div>

<div id="tasks">
    <table>
        <thead>
            <tr>
               <th>ID</th>
               <th class="name">名称</th>
               <th class="params">参数</th>
               <th class="time">用时</th>
           </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

<div id="jobs">
    <table>
        <thead>
            <tr>
               <th onclick="setSort(1, this)" class="name">名称</th>
               <th onclick="setSort(2, this)" class="load">负载</th>
               <th onclick="setSort(3, this)" class="now">执行中</th>
               <th onclick="setSort(4, this)" class="run">己执行</th>
               <th onclick="setSort(5, this)" class="old">昨天</th>
               <th onclick="setSort(6, this)" class="wait">队列</th>
               <th onclick="setSort(7, this)" class="time">平均时间</th>
               <th onclick="setSort(8, this)" class="score">优先级</th>
               <th>上次</th>
           </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

<script>
var tab = 3;
function setTab(by) {
    $("#tab span").removeClass("active")
    $("#tasks").hide()
    $("#jobs").hide()

    tab = by;

    switch(by) {
        case 1:
            $("#tab .run").addClass("active")
            $("#tasks").show()
            break;
        case 2:
            $("#tab .wait").addClass("active")
            $("#jobs").show()
            break;
        case 3:
            $("#tab .idle").addClass("active")
            $("#jobs").show()
            break;
        case 4:
            $("#tab .all").addClass("active")
            $("#jobs").show()
            break;
    }
}

var sortby = 2;
var oldEle;

function setSort(by, ele)
{
    if (oldEle) {
        var txt = oldEle.innerHTML;
        txt = txt.replace(/(\s|↓|↑)+/, "")
        oldEle.innerHTML = txt;
    }
    oldEle = ele;


    if (by == sortby) {
        by = -by
        ele.innerHTML += " ↑"
    } else {
        ele.innerHTML += " ↓"
    }

    sortby = by
}

function taskCancel(task)
{
    var ok = confirm("Cancel Task?\r\nid: " + task.Id + " Params: " + JSON.stringify(task.Params))
    if (ok) {
        $.getJSON("/api/task/cancel?id="+encodeURIComponent(task.Id), function(json){
            alert(JSON.stringify(json));
        });
    }
}

function jobEmpty(job)
{
    var ok = confirm("Empty Job?\r\nName: " + job.Name)
    if (ok) {
        $.getJSON("/api/job/empty?name="+encodeURIComponent(job.Name), function(json){
            alert(JSON.stringify(json));
        });
    }
}

function jobPriority(job)
{
    var txt = prompt("Job: "+job.Name+" Priority: ", "")
    if (txt!=null && txt!="") {
        $.getJSON("/api/job/priority?name="+encodeURIComponent(job.Name)+"&priority="+encodeURIComponent(txt), function(json){
            alert(JSON.stringify(json));
        });
    }

}

function showStatus() {
    $.getJSON("/api/status", function(json){
        var j = json.Data.All;

        var html = "";

        html = "<tr>"
        html += '<td>总体</td>';
        html += '<td>'+Math.round(j.Load/100)+'%</td>';
        html += '<td>'+j.NowNum+'</td>';
        html += '<td>'+j.RunNum+'</td>';
        html += '<td>'+j.OldNum+'</td>';
        html += '<td>'+j.WaitNum+'</td>';
        html += "</tr>"
        $("#All table tbody").html(html);

        json.Data.Tasks.sort(function(a, b){
            return a.Id.localeCompare(b.Id)
        });

        if (tab == 2 || tab == 3) {
            json.Data.Jobs = json.Data.Jobs.filter(function(job){
                if (tab == 3) {
                    return job.NowNum == 0 && job.WaitNum == 0;
                }
                return job.NowNum > 0 || job.WaitNum > 0;
            });
        }

       json.Data.Jobs.sort(function(a, b){
            var x = (function(){
                switch (Math.abs(sortby)) {
                case 1: return b.Name.localeCompare(a.Name)
                case 2: return (b.Load != a.Load) ? b.Load - a.Load : b.Score - a.Score;
                case 3: return (b.NowNum != a.NowNum) ? b.NowNum - a.NowNum : b.Score - a.Score;
                case 4: return (b.RunNum != a.RunNum) ? b.RunNum - a.RunNum : b.Score - a.Score;
                case 5: return (b.OldNum != a.OldNum) ? b.OldNum - a.OldNum : b.Score - a.Score;
                case 6: return (b.WaitNum != a.WaitNum) ? b.WaitNum - a.WaitNum : b.Score - a.Score;
                case 7: return (b.UseTime != a.UseTime) ? b.UseTime - a.UseTime : b.Score - a.Score;
                case 8: return (a.Score != b.Score) ? b.Score - a.Score : b.Name.localeCompare(a.Name);
                }
            })()
            return sortby > 0 ? x : -x;
        });

        html = "";
        for (var i=0; i<json.Data.Tasks.length; i++) {
            var j = json.Data.Tasks[i];
            html += "<tr>"
            html += "<td><span ondblclick='taskCancel("+JSON.stringify(j)+")'>"+j.Id+"</span></td>";
            html += '<td>'+j.Name+'</td>';
            html += '<td>'+j.Params.join(" ")+'</td>';
            html += '<td>'+(j.UseTime/1000)+'s</td>';
            html += "</tr>"
        }
        if (json.Data.Tasks.length == 0) {
            html = "<tr><td colspan='4' class='center'>empty</td>";
        }
        $("#tasks table tbody").html(html);

        html = "";
        for (var i=0; i<json.Data.Jobs.length; i++) {
            var j = json.Data.Jobs[i];
            html += "<tr>"
            html += '<td>'+j.Name+'</td>';
            html += '<td>'+(j.Load/100)+'%</td>';
            html += '<td>'+j.NowNum+'</td>';
            html += '<td>'+j.RunNum+'</td>';
            html += '<td>'+j.OldNum+'</td>';
            html += "<td><span ondblclick='jobEmpty("+JSON.stringify(j)+")'>"+j.WaitNum+"</span></td>";
            html += '<td>'+(j.UseTime/1000)+'s</td>';
            html += "<td><span ondblclick='jobPriority("+JSON.stringify(j)+")'>";
            html += j.Score + (j.Priority==0?"":(j.Priority > 0 ? "(+" + j.Priority+")" : "("+j.Priority+")"));
            html += '<span></td>';
            html += '<td>'+j.LastTime+'s</td>';
            html += "</tr>"
        }
        if (json.Data.Jobs.length == 0) {
            html = "<tr><td colspan='9' class='center'>empty</td>";
        }
        $("#jobs table tbody").html(html);
    });
}

window.onload = function(){
    setTab(2)
    showStatus();
};

window.setInterval(function(){
    showStatus();
}, 1000);

</script>

</body>
</html>
