<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <script src="/jquery-3.2.1.min.js"></script>
    <style>
body{
    padding:0;
    margin:5px;
}

.table {
    width:100%;
    border-collapse:collapse;
}
.table td, .table th{
    border:1px solid #777;
    padding: 0px 1em;
}
.load{
    width:5em;
}
.time{
    width:5em;
}
.center {
    text-align:center;
}
.current .name{
    color:green;
}

.confirm_msg{
    text-align:center;
    font-size:24px;
}
.confirm_button{
    text-align:center;
    font-size:24px;
}
.confirm_button a{
    color:#000;
    text-decoration:none;
}

.button{
    text-align:center;
}
.button a{
    color:#000;
    text-decoration:none;
}

    </style>
</head>
<body>

<div style="width:500px">
    <div id="All" style="float:left;">
        <table>
            <thead>
                <tr>
                   <th class="name">名称</th>
                   <th class="load">负载</th>
                   <th class="now">执行中</th>
                   <th class="run">己执行</th>
                   <th class="old">昨天</th>
                   <th class="wait">队列</th>
               </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>

    <div style="float:right;">
    <label for="sortby">排序:</label>
    <select id="sortby">
        <option value="0">名称正序</option>
        <option value="1">名称倒序</option>
        <option selected value="2">占用</option>
        <option value="3">执行中</option>
        <option value="4">己执行</option>
        <option value="5">昨天</option>
        <option value="6">队列</option>
        <option value="7">平均时间</option>
        <option value="8">分值</option>
    </select>
    </div>

    <div style="clear:both;"></div>
</div>

<div id="tasks">
    <table>
        <thead>
            <tr>
               <th class="name">名称</th>
               <th class="params">参数</th>
               <th class="time">用时</th>
               <th class="cmd"></th>
           </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

<div id="jobs">
    <table>
        <thead>
            <tr>
               <th class="name">名称</th>
               <th class="load">负载</th>
               <th>执行中</th>
               <th>己执行</th>
               <th>昨天</th>
               <th>队列</th>
               <th class="time">平均时间</th>
               <th class="score">分值</th>
               <th class="cmd"></th>
           </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

<script>

function showStatus() {
    $.getJSON("/api/status", function(json){
        var j = json.Data.All;

        var html = "";

        html = "<tr>"
        html += '<td>总体</td>';
        html += '<td>'+(j.Load/100)+'%</td>';
        html += '<td>'+j.NowNum+'</td>';
        html += '<td>'+j.RunNum+'</td>';
        html += '<td>'+j.OldNum+'</td>';
        html += '<td>'+j.WaitNum+'</td>';
        html += "</tr>"
        $("#All table tbody").html(html);

        var sortby = $("#sortby").val();

        json.Data.Tasks = json.Data.Tasks.sort(function(a, b){
            return a.Id.localeCompare(b.Id)
        });

        json.Data.Jobs = json.Data.Jobs.sort(function(a, b){
            switch (sortby) {
            case "0": return a.Name.localeCompare(b.Name)
            case "1": return b.Name.localeCompare(a.Name)
            case "2": return (b.Load != a.Load) ? b.Load - a.Load : a.Score > b.Score;
            case "3": return (b.NowNum != a.NowNum) ? b.NowNum - a.NowNum : a.Score > b.Score;
            case "4": return (b.RunNum != a.RunNum) ? b.RunNum - a.RunNum : a.Score > b.Score;
            case "5": return (b.OldNum != a.OldNum) ? b.OldNum - a.OldNum : a.Score > b.Score;
            case "6": return (b.WaitNum != a.WaitNum) ? b.WaitNum - a.WaitNum : a.Score > b.Score;
            case "7": return (b.UseTime != a.UseTime) ? b.UseTime - a.UseTime : a.Score > b.Score;
            case "8": return (a.Score != b.Score) ? a.Score > b.Score : a.Name.localeCompare(b.Name);
            }
        });

        html = "";
        for (var i=0; i<json.Data.Tasks.length; i++) {
            var j = json.Data.Tasks[i];
            html += "<tr>"
            html += '<td>'+j.Name+'</td>';
            html += '<td>'+j.Params.join(" ")+'</td>';
            html += '<td>'+(j.UseTime/1000)+'s</td>';
            html += '<td></td>';
            html += "</tr>"
        }
        if (json.Data.Tasks.length == 0) {
            html = "<tr><td colspan='4' class='center'>empty</td>";
        }
        $("#tasks table tbody").html(html);

        html = "";
        for (var i=0; i<json.Data.Jobs.length; i++) {
            var j = json.Data.Jobs[i];
            html += "<tr>"
            html += '<td>'+j.Name+'</td>';
            html += '<td>'+(j.Load/100)+'%</td>';
            html += '<td>'+j.NowNum+'</td>';
            html += '<td>'+j.RunNum+'</td>';
            html += '<td>'+j.OldNum+'</td>';
            html += '<td>'+j.WaitNum+'</td>';
            html += '<td>'+(j.UseTime/1000)+'s</td>';
            html += '<td>'+j.Score+'</td>';
            html += '<td></td>';
            html += "</tr>"
        }
        if (json.Data.Jobs.length == 0) {
            html = "<tr><td colspan='9' class='center'>empty</td>";
        }
        $("#jobs table tbody").html(html);
    });
}

window.onload = function(){
    showStatus();
};

window.setInterval(function(){
    showStatus();
}, 1000);

</script>

</body>
</html>
